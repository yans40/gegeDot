<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Real Data</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        svg { border: 1px solid #ccc; }
        .node { cursor: pointer; }
        .link { stroke: #4A90E2; stroke-width: 2px; fill: none; }
        .tooltip { position: absolute; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; pointer-events: none; }
    </style>
</head>
<body>
    <h1>Test avec Vraies Données</h1>
    <button onclick="loadRealData()">Charger Charles Windsor</button>
    <svg width="800" height="600" id="testSvg"></svg>
    <div id="tooltip" class="tooltip" style="display: none;"></div>
    <div id="info"></div>

    <script>
        const API_BASE_URL = 'http://localhost:5001/api';

        async function loadRealData() {
            try {
                // Récupérer les données de Charles Windsor
                const response = await fetch(`${API_BASE_URL}/persons/10/family`);
                const familyData = await response.json();
                
                console.log('Données familiales réelles:', familyData);
                
                // Créer des nœuds de test avec les vraies données
                const nodes = [
                    { id: 10, name: 'Charles Windsor', x: 400, y: 300, type: 'main' },
                    { id: 8, name: 'Elizabeth Windsor', x: 300, y: 200, type: 'parent' },
                    { id: 9, name: 'Philip Mountbatten', x: 500, y: 200, type: 'parent' },
                    { id: 11, name: 'Anne Windsor', x: 200, y: 300, type: 'sibling' },
                    { id: 12, name: 'Andrew Windsor', x: 600, y: 300, type: 'sibling' }
                ];

                // Créer des liens de test avec les vraies données
                const links = [
                    { source: 8, target: 10, type: 'parent-child' },
                    { source: 9, target: 10, type: 'parent-child' },
                    { source: 8, target: 11, type: 'parent-child' },
                    { source: 9, target: 11, type: 'parent-child' },
                    { source: 8, target: 12, type: 'parent-child' },
                    { source: 9, target: 12, type: 'parent-child' }
                ];

                console.log('Nœuds:', nodes);
                console.log('Liens:', links);

                renderTest(nodes, links);

            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('info').innerHTML = `<p style="color: red;">Erreur: ${error.message}</p>`;
            }
        }

        function renderTest(nodes, links) {
            const svg = d3.select('#testSvg');
            svg.selectAll('*').remove();

            // Créer les liens (invisibles par défaut)
            const link = svg.selectAll('.link')
                .data(links)
                .enter().append('line')
                .attr('class', 'link')
                .attr('x1', d => {
                    const sourceNode = nodes.find(n => n.id === d.source);
                    return sourceNode ? sourceNode.x : 0;
                })
                .attr('y1', d => {
                    const sourceNode = nodes.find(n => n.id === d.source);
                    return sourceNode ? sourceNode.y : 0;
                })
                .attr('x2', d => {
                    const targetNode = nodes.find(n => n.id === d.target);
                    return targetNode ? targetNode.x : 0;
                })
                .attr('y2', d => {
                    const targetNode = nodes.find(n => n.id === d.target);
                    return targetNode ? targetNode.y : 0;
                })
                .style('opacity', 0); // Invisible par défaut

            // Créer les nœuds
            const node = svg.selectAll('.node')
                .data(nodes)
                .enter().append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${d.x},${d.y})`);

            node.append('circle')
                .attr('r', d => d.type === 'main' ? 20 : 15)
                .attr('fill', d => d.type === 'main' ? '#F39C12' : '#4A90E2');

            node.append('text')
                .attr('dy', 25)
                .attr('text-anchor', 'middle')
                .text(d => d.name);

            // Gestion du survol
            node.on('mouseover', function(event, d) {
                console.log('Survol de:', d.name, 'ID:', d.id);
                
                // Afficher les liens connectés
                link.style('opacity', l => {
                    const isConnected = (l.source === d.id || l.target === d.id);
                    console.log(`Lien ${l.source} -> ${l.target}: ${isConnected ? 'visible' : 'invisible'}`);
                    return isConnected ? 1 : 0;
                });

                // Highlight des nœuds connectés
                node.style('opacity', n => {
                    const isConnected = (n.id === d.id || 
                        links.some(l => 
                            (l.source === d.id && l.target === n.id) ||
                            (l.target === d.id && l.source === n.id)
                        ));
                    return isConnected ? 1 : 0.3;
                });

                // Tooltip
                const connectedPersons = links
                    .filter(l => l.source === d.id || l.target === d.id)
                    .map(l => {
                        const connectedId = l.source === d.id ? l.target : l.source;
                        const connectedNode = nodes.find(n => n.id === connectedId);
                        return connectedNode ? connectedNode.name : connectedId;
                    });

                d3.select('#tooltip')
                    .style('display', 'block')
                    .html(`
                        <h3>${d.name}</h3>
                        <p>Liens: ${connectedPersons.join(', ')}</p>
                    `)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 10) + 'px');
            })
            .on('mouseout', function() {
                console.log('Fin du survol');
                
                // Cacher tous les liens
                link.style('opacity', 0);

                // Reset des nœuds
                node.style('opacity', 1);

                d3.select('#tooltip').style('display', 'none');
            });

            document.getElementById('info').innerHTML = `
                <h3>Test avec Vraies Données</h3>
                <p>Nœuds: ${nodes.length}</p>
                <p>Liens: ${links.length}</p>
                <p>Liens détaillés:</p>
                <ul>
                    ${links.map(l => `<li>${l.source} -> ${l.target} (${l.type})</li>`).join('')}
                </ul>
            `;
        }
    </script>
</body>
</html>






